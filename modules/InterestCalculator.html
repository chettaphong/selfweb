<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan and Investment Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font for a modern look -->
    <style>
        @import url('https://fonts.fonts.gstatic.com/s/inter/v13/UcCO4Fq0J9f-UCjGeqI1Mz-mluY.woff2') format('woff2');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        /* Fixed-width font for numerical alignment */
        .font-mono-numbers {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start min-h-screen">

    <div class="w-full max-w-5xl bg-white shadow-xl rounded-2xl p-6 md:p-10 border border-gray-100">

        <!-- Title and Description -->
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 border-b pb-2">Financial Mode Calculator</h1>
        <p class="text-gray-500 mb-6">Switch between Loan Amortization, Leasing, and Investment Growth modes.</p>

        <!-- MAIN LAYOUT GRID: 1 column on mobile, 3 columns (1/3 for inputs, 2/3 for outputs) on large screens -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- INPUTS COLUMN (1/3 width on large screens) -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Mode Selector -->
                <div class="bg-indigo-50 p-3 rounded-lg shadow-inner">
                    <label class="block text-sm font-bold text-indigo-700 mb-2">Calculation Mode</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="calcMode" value="investment" id="modeInvestment" checked class="form-radio text-indigo-600 focus:ring-indigo-500" onchange="updateUI()">
                            <span class="text-gray-700 font-medium">Investment</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="calcMode" value="loan" id="modeLoan" class="form-radio text-indigo-600 focus:ring-indigo-500" onchange="updateUI()">
                            <span class="text-gray-700 font-medium">Loan/Leasing</span>
                        </label>
                    </div>
                </div>
                
                <!-- Currency Selector -->
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                    <select id="currency" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out bg-white">
                        <option value="THB" selected>Thai Baht (THB)</option>
                        <option value="USD">US Dollar (USD)</option>
                        <option value="EUR">Euro (EUR)</option>
                        <option value="JPY">Japanese Yen (JPY)</option>
                        <option value="GBP">British Pound (GBP)</option>
                        <option value="AUD">Australian Dollar (AUD)</option>
                        <option value="CAD">Canadian Dollar (CAD)</option>
                    </select>
                </div>

                <!-- Principal/Asset Input (Dynamic Label) -->
                <div>
                    <label for="principal" id="labelPrincipal" class="block text-sm font-medium text-gray-700 mb-1">Loan Principal Amount</label>
                    <input type="number" id="principal" value="1000000" min="0" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="1,000,000">
                </div>

                <!-- Leasing Mode Toggle -->
                <div id="divLeasingToggle" style="display: none;">
                    <label class="flex items-center space-x-2 cursor-pointer bg-blue-50 p-3 rounded-lg shadow-inner">
                        <input type="checkbox" id="isLeasing" class="form-checkbox text-blue-600 focus:ring-blue-500" onchange="updateUI()">
                        <span class="text-gray-700 font-medium font-semibold">Activate Leasing Calculation</span>
                    </label>
                </div>

                <!-- Down Payment & Residual Value Section -->
                <div id="divDownPayment" style="display: none;" class="space-y-4 p-4 border border-blue-200 bg-blue-50 rounded-lg">
                    <h3 class="text-sm font-bold text-blue-700 border-b pb-2">Leasing Details</h3>
                    
                    <!-- Down Payment Input (Absolute or Percent) -->
                    <div>
                        <label for="downPaymentValue" class="block text-sm font-medium text-gray-700 mb-1">Down Payment Amount</label>
                        <div class="flex rounded-lg shadow-sm">
                            <input type="number" id="downPaymentValue" value="10" min="0" step="0.5" 
                                class="block w-full p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500"
                                oninput="handleDownPaymentInput(event)">
                            
                            <!-- Unit Selector -->
                            <div class="flex border border-gray-300 border-l-0 rounded-r-lg bg-white divide-x divide-gray-200">
                                <label class="flex items-center px-3 py-3 cursor-pointer">
                                    <input type="radio" name="downPaymentUnit" value="percent" id="unitPercent" checked class="form-radio text-blue-600 focus:ring-blue-500" onchange="handleUnitChange('percent')">
                                    <span class="text-sm text-gray-700 ml-1 font-medium">%</span>
                                </label>
                                <label class="flex items-center px-3 py-3 cursor-pointer">
                                    <input type="radio" name="downPaymentUnit" value="absolute" id="unitAbsolute" class="form-radio text-blue-600 focus:ring-blue-500" onchange="handleUnitChange('absolute')">
                                    <span class="text-sm text-gray-700 ml-1 font-medium">Abs.</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Calculated Down Payment Absolute/Percent Value (Read-only display) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Down Payment (Absolute)</label>
                            <div id="downPaymentAbsoluteDisplay" class="w-full p-3 bg-white text-gray-800 font-semibold rounded-lg border border-gray-300 shadow-inner">0.00</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Down Payment (Percent)</label>
                            <div id="downPaymentPercentDisplay" class="w-full p-3 bg-white text-gray-800 font-semibold rounded-lg border border-gray-300 shadow-inner">0.00%</div>
                        </div>
                    </div>
                    
                    <!-- Residual Value Input - Value changed to 0 -->
                    <div>
                        <label for="residualValue" class="block text-sm font-medium text-gray-700 mb-1">Residual/Balloon Value</label>
                        <input type="number" id="residualValue" value="0" min="0" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="0">
                    </div>
                </div>

                <!-- Rate Input -->
                <div>
                    <label for="rate" class="block text-sm font-medium text-gray-700 mb-1">Annual Interest Rate (%)</label>
                    <input type="number" id="rate" value="0" min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="0.0">
                </div>

                <!-- VAT Input (New, shown only for Loan mode) -->
                <div id="divVATRate" style="display: none;">
                    <label for="vatRate" class="block text-sm font-medium text-gray-700 mb-1">VAT on Interest (%)</label>
                    <input type="number" id="vatRate" value="7" min="0" max="100" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="7.0">
                    <p class="text-xs text-gray-500 mt-1">
                        Tax applied to the interest portion of the payment.
                    </p>
                </div>

                <!-- Duration Input -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
                        <input type="number" id="duration" value="5" min="1" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="5">
                    </div>
                    <div>
                        <label for="durationUnit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <select id="durationUnit" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out bg-white">
                            <option value="years">Years</option>
                            <option value="months">Months</option>
                        </select>
                    </div>
                </div>

                <!-- Monthly Contribution/Payment Input (Dynamic Label) -->
                <div id="divMonthlyPayment" style="display: none;">
                    <label for="monthlyPayment" id="labelMonthlyPayment" class="block text-sm font-medium text-gray-700 mb-1">Monthly Contribution (Optional)</label>
                    <input type="number" id="monthlyPayment" value="0" min="0" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="0">
                    <p id="hintMonthlyPayment" class="text-xs text-gray-500 mt-1">
                        Add a fixed amount contributed monthly.
                    </p>
                </div>
                
                <!-- Interest Type Selector (Dynamic Options) -->
                <div>
                    <label for="interestType" class="block text-sm font-medium text-gray-700 mb-1">Type of Rate</label>
                    <select id="interestType" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out bg-white">
                        <!-- Options updated dynamically -->
                    </select>
                </div>

                <button id="calculateBtn" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    Calculate Schedule
                </button>

            </div>

            <!-- OUTPUTS & SUMMARY COLUMN (2/3 width on large screens) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Summary Card -->
                <div class="bg-gray-50 border border-gray-200 p-5 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-3" id="summaryTitle">Loan Summary</h2>
                    <div id="summaryContent" class="space-y-2">
                        <!-- Summary items injected here -->
                    </div>
                </div>

                <!-- Monthly Schedule Table -->
                <div class="table-container w-full overflow-x-auto border border-gray-200 rounded-xl shadow-md">
                    <div class="p-4 bg-gray-100 rounded-t-xl sticky top-0 z-10">
                        <h2 class="text-lg font-bold text-gray-800" id="tableTitle">Amortization Schedule</h2>
                    </div>
                    
                    <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                        <thead id="tableHead" class="bg-gray-50 sticky top-[3rem] z-10">
                            <!-- Headers injected here -->
                        </thead>
                        <!-- Added font-mono-numbers class for fixed-width numerical alignment -->
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200 font-mono-numbers">
                            <tr><td colspan="7" class="p-4 text-center text-gray-500 italic">Select mode and enter parameters to see the schedule.</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- COPY SCHEDULE BUTTONS (Moved to the bottom) -->
                <div id="exportContainer" style="display: none;" class="w-full bg-gray-100 p-4 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800 mb-3">Export Schedule</h2>
                    <div class="flex space-x-4">
                        <button onclick="copySchedule('tab')" class="flex-1 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-200">
                            Copy to Excel (Tab-Separated)
                        </button>
                        <button onclick="copySchedule('markdown')" class="flex-1 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-200">
                            Copy as Markdown
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal for Messages (Used instead of alert/confirm) -->
    <div id="messageModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-800 mb-2" id="modalTitle"></h3>
            <p class="text-gray-600 mb-4" id="modalMessage"></p>
            <button onclick="closeModal()" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">OK</button>
        </div>
    </div>

    <script>
        // Set up the required global variables for the Firebase environment
        const __app_id = typeof globalThis.__app_id !== 'undefined' ? globalThis.__app_id : 'default-app-id';
        const __firebase_config = typeof globalThis.__firebase_config !== 'undefined' ? globalThis.__firebase_config : '{}';
        const __initial_auth_token = typeof globalThis.__initial_auth_token !== 'undefined' ? globalThis.__initial_auth_token : '';
        
        // State to track the last type of down payment input (absolute or percent)
        let lastEditedDownPayment = 'percent'; 

        // --- Modal Functions ---
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
            document.getElementById('messageModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('messageModal').classList.add('hidden');
            document.getElementById('messageModal').classList.remove('flex');
        }

        // --- Formatting and Utility Functions ---

        function getLocale(currencyCode) {
            switch (currencyCode) {
                case 'THB': return 'th-TH';
                case 'JPY': return 'ja-JP';
                case 'EUR': return 'fr-FR'; 
                default: return 'en-US';
            }
        }

        function formatNumber(amount, currencyCode, isCurrency = true) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return '0.00';
            }
            const options = {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            };
            return new Intl.NumberFormat(getLocale(currencyCode), options).format(amount);
        }
        
        function formatPercent(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return '0.00%';
            }
            return `${amount.toFixed(2)}%`;
        }

        /**
         * Calculates the fixed monthly payment for a compounding (amortized) loan.
         */
        function calculateMonthlyPayment(principal, monthlyRate, totalMonths) {
            if (monthlyRate === 0) {
                return principal / totalMonths;
            }
            const ratePowerN = Math.pow(1 + monthlyRate, totalMonths);
            const payment = principal * (monthlyRate * ratePowerN) / (ratePowerN - 1);
            return payment;
        }

        // --- Down Payment Handlers ---
        
        function updateDownPaymentDisplays(principal, downPaymentValue, downPaymentUnit) {
            let downPaymentAbsolute = 0;
            let downPaymentPercent = 0;
            
            if (principal <= 0) {
                downPaymentAbsolute = 0;
                downPaymentPercent = 0;
            } else if (downPaymentUnit === 'percent') {
                downPaymentPercent = Math.min(100, Math.max(0, parseFloat(downPaymentValue) || 0));
                downPaymentAbsolute = (downPaymentPercent / 100) * principal;
            } else { // absolute
                downPaymentAbsolute = Math.min(principal, Math.max(0, parseFloat(downPaymentValue) || 0));
                downPaymentPercent = (downPaymentAbsolute / principal) * 100;
            }

            const currencyCode = document.getElementById('currency').value;
            
            // Set values back to the hidden or read-only elements
            document.getElementById('downPaymentAbsoluteDisplay').textContent = formatNumber(downPaymentAbsolute, currencyCode);
            document.getElementById('downPaymentPercentDisplay').textContent = formatPercent(downPaymentPercent);
        }

        function handleDownPaymentInput(event) {
            const downPaymentInput = document.getElementById('downPaymentValue');
            const downPaymentUnit = document.querySelector('input[name="downPaymentUnit"]:checked').value;
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            
            // Set the state to the last edited field for calculation purposes
            lastEditedDownPayment = downPaymentUnit; 
            
            // Recalculate and update displays
            updateDownPaymentDisplays(principal, downPaymentInput.value, downPaymentUnit);
            
            // Re-render the schedule
            renderResults();
        }

        function handleUnitChange(newUnit) {
            const downPaymentInput = document.getElementById('downPaymentValue');
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            
            // When unit changes, we need to convert the displayed value in the input field
            let newValue = 0;
            
            if (lastEditedDownPayment === 'percent' && newUnit === 'absolute') {
                // Was percent, now switch to absolute -> Show absolute amount
                const currentPercent = parseFloat(downPaymentInput.value) || 0;
                newValue = (currentPercent / 100) * principal;
            } else if (lastEditedDownPayment === 'absolute' && newUnit === 'percent') {
                // Was absolute, now switch to percent -> Show percentage
                const currentAbsolute = parseFloat(downPaymentInput.value) || 0;
                newValue = (currentAbsolute / principal) * 100;
            } else if (principal > 0) {
                 // Initial load or consistent unit, use the last edited absolute/percent value
                 const absoluteDisplay = document.getElementById('downPaymentAbsoluteDisplay').textContent;
                 const percentDisplay = document.getElementById('downPaymentPercentDisplay').textContent;
                 
                 if (newUnit === 'absolute') {
                    // Try to extract the displayed absolute value
                    newValue = parseFloat(absoluteDisplay.replace(/[^0-9.-]+/g,"")) || 0;
                 } else {
                    // Try to extract the displayed percentage value
                    newValue = parseFloat(percentDisplay.replace('%', '')) || 0;
                 }
            }

            downPaymentInput.value = newValue.toFixed(2);
            lastEditedDownPayment = newUnit; // New unit is the dominant input source now
            
            // Recalculate and update displays based on the new unit/value
            updateDownPaymentDisplays(principal, downPaymentInput.value, newUnit);
            
            renderResults();
        }
        
        // --- Core Calculation Logic ---

        function calculateLoan(principal, annualRate, totalMonths, monthlyRate, interestType, vatRate, isLeasing, downPaymentAbsolute, residualValue) {
            
            // Determine the amount to be amortized (the 'Effective Principal')
            let effectivePrincipal = principal - downPaymentAbsolute;
            if (effectivePrincipal < 0) effectivePrincipal = 0; // Handle over-payment on DP

            // The value that needs to be reduced to zero by the amortization payment
            let loanAmountToAmortize = effectivePrincipal;

            if (isLeasing) {
                // For leasing, the principal reduction is (effectivePrincipal - residualValue)
                loanAmountToAmortize = effectivePrincipal - residualValue;
                if (loanAmountToAmortize < 0) loanAmountToAmortize = 0;
            }

            let remainingBalance = effectivePrincipal;
            let totalInterest = 0;
            let totalVAT = 0; 
            let monthlyPayment = 0;
            let schedule = [];
            
            const monthlyVATRate = vatRate / 100;

            // 1. Determine the fixed base monthly payment
            let fixedMonthlyInterest = 0;
            
            if (interestType === 'compound' || (isLeasing && interestType === 'compound')) { 
                // Use standard amortization formula for compound/effective rate or all leasing options
                if (monthlyRate === 0) {
                    monthlyPayment = totalMonths > 0 ? loanAmountToAmortize / totalMonths : 0;
                } else {
                    monthlyPayment = calculateMonthlyPayment(loanAmountToAmortize, monthlyRate, totalMonths);
                }
            } else {
                // Use Simple Interest formula for FIXED rate loans (Loan/Leasing)
                const totalSimpleInterest = effectivePrincipal * (annualRate / 100) * (totalMonths / 12);
                monthlyPayment = totalMonths > 0 ? (loanAmountToAmortize + totalSimpleInterest) / totalMonths : 0;

                // Pre-calculate fixed monthly interest for simple rate mode
                fixedMonthlyInterest = totalMonths > 0 ? totalSimpleInterest / totalMonths : 0;
            }
            
            let totalBasePayment = 0;
            
            // 2. Run the amortization/schedule loop
            for (let month = 1; month <= totalMonths; month++) {
                
                // Stop calculation if balance reaches minimum residual (for lease) or zero (for loan)
                if (isLeasing && remainingBalance <= residualValue) break;
                if (!isLeasing && remainingBalance <= 0) break;

                const startingBalance = remainingBalance;
                let interestPaid = 0;
                let principalPaid = 0;
                let basePayment = monthlyPayment; 

                if (interestType === 'compound' || (isLeasing && interestType === 'compound')) { 
                    
                    // --- COMPOUND / EFFECTIVE RATE LOGIC (Including all Leasing) ---
                    interestPaid = startingBalance * monthlyRate;
                    principalPaid = basePayment - interestPaid;
                    
                    // Final month adjustment
                    let targetResidual = isLeasing ? residualValue : 0;
                    if (startingBalance - principalPaid < targetResidual) {
                        principalPaid = startingBalance - targetResidual;
                        basePayment = principalPaid + interestPaid;
                    }
                    
                } else if (interestType === 'simple' && !isLeasing) {
                    
                    // --- SIMPLE / FIXED RATE LOAN LOGIC (NON-LEASING) ---
                    interestPaid = fixedMonthlyInterest; 
                    principalPaid = monthlyPayment - interestPaid; 
                    basePayment = monthlyPayment;

                    // Final month adjustment: Principal must clear the remaining balance cleanly
                    if (startingBalance <= principalPaid) { 
                        principalPaid = startingBalance;
                        // Recalculate base payment based on final principal and fixed monthly interest
                        basePayment = principalPaid + fixedMonthlyInterest; 
                        interestPaid = fixedMonthlyInterest;
                    }

                } else if (interestType === 'simple' && isLeasing) {
                    
                    // --- SIMPLE / FIXED RATE LEASING LOGIC ---
                    interestPaid = fixedMonthlyInterest;
                    principalPaid = monthlyPayment - interestPaid;
                    basePayment = monthlyPayment;
                    
                    // Final adjustment for leasing to hit the residual value exactly
                    if (startingBalance - principalPaid < residualValue) {
                        principalPaid = startingBalance - residualValue;
                        basePayment = principalPaid + fixedMonthlyInterest;
                        interestPaid = fixedMonthlyInterest;
                    }
                }
                
                // VAT Calculation
                const vatAmount = interestPaid * monthlyVATRate;
                const totalPayment = basePayment + vatAmount; 

                remainingBalance -= principalPaid;
                totalInterest += interestPaid;
                totalVAT += vatAmount;
                totalBasePayment += basePayment;
                
                // Ensure remaining balance doesn't drop below minimum
                remainingBalance = Math.max(isLeasing ? residualValue : 0, remainingBalance); 

                schedule.push({
                    month: month,
                    startingBalance: startingBalance,
                    payment: totalPayment, 
                    interestPaid: interestPaid, 
                    vatAmount: vatAmount, 
                    principalPaid: principalPaid,
                    endingBalance: remainingBalance,
                });
            }
            
            let finalAmount = effectivePrincipal + totalInterest + totalVAT; 
            let finalResidualDue = 0;

            if (isLeasing) {
                finalResidualDue = remainingBalance; 
                
                // Final cost must include the Down Payment, total base payments, total VAT, and the final residual value
                finalAmount = downPaymentAbsolute + totalBasePayment + totalVAT;
                
                // Add the final payment row for the residual value
                if (finalResidualDue > 0) {
                    schedule.push({
                        month: totalMonths + 1,
                        startingBalance: finalResidualDue,
                        payment: finalResidualDue, 
                        interestPaid: 0,
                        vatAmount: 0, 
                        principalPaid: finalResidualDue,
                        endingBalance: 0,
                        isResidual: true
                    });
                    finalAmount += finalResidualDue; // Add residual to total cost
                }
            }


            return {
                type: 'loan',
                isLeasing: isLeasing, 
                schedule: schedule,
                totalMonths: totalMonths,
                totalInterest: totalInterest,
                totalVAT: totalVAT, 
                finalAmount: finalAmount, 
                initialAssetValue: principal, 
                downPaymentAbsolute: downPaymentAbsolute, 
                residualValue: finalResidualDue, 
                monthlyFixedAmount: monthlyPayment, 
                totalPrincipalFinanced: effectivePrincipal,
            };
        }

        function calculateInvestment(principal, annualRate, totalMonths, monthlyRate, interestType, monthlyContribution) {
            let currentBalance = principal;
            let totalInterest = 0;
            let totalContributions = monthlyContribution * totalMonths;
            let schedule = [];

            for (let month = 1; month <= totalMonths; month++) {
                const startingBalance = currentBalance;
                let interestEarned = 0;
                
                if (interestType === 'compound') {
                    interestEarned = startingBalance * monthlyRate;
                } else {
                    // Simple interest investment: based only on initial principal
                    interestEarned = principal * monthlyRate;
                }

                currentBalance += interestEarned;
                currentBalance += monthlyContribution;
                totalInterest += interestEarned;

                schedule.push({
                    month: month,
                    startingBalance: startingBalance,
                    interestEarned: interestEarned,
                    contribution: monthlyContribution,
                    endingBalance: currentBalance,
                });
            }

            return {
                type: 'investment',
                isLeasing: false,
                schedule: schedule,
                totalMonths: totalMonths,
                totalInterest: totalInterest,
                finalAmount: currentBalance,
                initialAmount: principal,
                monthlyFixedAmount: monthlyContribution,
                totalContributions: totalContributions,
            };
        }
        
        // --- UI and Rendering ---
        
        function getInputs() {
            const mode = document.querySelector('input[name="calcMode"]:checked').value;
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const annualRate = parseFloat(document.getElementById('rate').value) || 0;
            const vatRate = parseFloat(document.getElementById('vatRate').value) || 0; 
            const duration = parseInt(document.getElementById('duration').value) || 0;
            const durationUnit = document.getElementById('durationUnit').value;
            const monthlyContribution = parseFloat(document.getElementById('monthlyPayment').value) || 0;
            const interestType = document.getElementById('interestType').value;
            
            // --- Leasing Inputs ---
            const isLeasing = document.getElementById('isLeasing')?.checked || false;
            const downPaymentInput = document.getElementById('downPaymentValue')?.value || 0;
            const downPaymentUnit = document.querySelector('input[name="downPaymentUnit"]:checked')?.value || 'percent';
            const residualValue = parseFloat(document.getElementById('residualValue')?.value) || 0;

            // Calculate absolute down payment based on the last edited unit and value
            let downPaymentAbsolute = 0;
            if (isLeasing) {
                if (lastEditedDownPayment === 'percent') {
                    // Calculate based on the percentage value in the input field
                    const percent = Math.min(100, Math.max(0, parseFloat(downPaymentInput) || 0));
                    downPaymentAbsolute = (percent / 100) * principal;
                } else {
                    // Calculate based on the absolute value in the input field
                    downPaymentAbsolute = Math.min(principal, Math.max(0, parseFloat(downPaymentInput) || 0));
                }
            }

            // Update the display for both absolute and percentage
            updateDownPaymentDisplays(principal, downPaymentInput, lastEditedDownPayment);


            // Basic input validation
            if ((mode === 'loan' && principal <= 0 && !isLeasing) || annualRate < 0 || duration <= 0) {
                 if (mode === 'loan' && principal > 0) return null; // Allow principal > 0
            }


            const totalMonths = durationUnit === 'years' ? duration * 12 : duration;
            const monthlyRate = (annualRate / 100) / 12;

            return { 
                mode, principal, annualRate, totalMonths, monthlyRate, interestType, monthlyContribution, vatRate,
                isLeasing, downPaymentAbsolute, residualValue
            };
        }

        function calculateResults() {
            const inputs = getInputs();
            if (!inputs) {
                return { schedule: [], totalMonths: 0, initialAssetValue: 0 };
            }

            const { mode, principal, annualRate, totalMonths, monthlyRate, interestType, monthlyContribution, vatRate, isLeasing, downPaymentAbsolute, residualValue } = inputs;
            
            if (mode === 'loan') {
                return calculateLoan(principal, annualRate, totalMonths, monthlyRate, interestType, vatRate, isLeasing, downPaymentAbsolute, residualValue);
            } else {
                return calculateInvestment(principal, annualRate, totalMonths, monthlyRate, interestType, monthlyContribution);
            }
        }

        let currentScheduleData = null; // Store the last calculated data for export

        function renderResults() {
            const results = calculateResults();
            const mode = document.querySelector('input[name="calcMode"]:checked').value;
            const tableBody = document.getElementById('tableBody');
            const currencyCode = document.getElementById('currency').value;
            const inputs = getInputs();
            
            tableBody.innerHTML = '';
            
            const isLeasing = inputs?.isLeasing || false;

            // Render Head
            renderTableHeader(mode, isLeasing);
            
            const colspan = mode === 'loan' ? 7 : 5; 
            
            if (!inputs || results.schedule.length === 0) {
                document.getElementById('exportContainer').style.display = 'none'; // Hide export button
                currentScheduleData = null;

                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="p-4 text-center text-gray-500 italic">Please enter valid positive values for ${mode === 'loan' ? (isLeasing ? 'Asset Value and Duration.' : 'Principal and Duration.') : 'Initial Investment and Duration.'}</td></tr>`;
                renderSummary(mode, null, currencyCode);
                return;
            }

            // Store data for export
            currentScheduleData = {
                mode: mode,
                isLeasing: isLeasing,
                schedule: results.schedule,
                headers: getTableHeaders(mode, isLeasing)
            };
            document.getElementById('exportContainer').style.display = 'block';

            // Render Body
            if (mode === 'loan') {
                results.schedule.forEach(row => {
                    const newRow = tableBody.insertRow();
                    newRow.className = row.isResidual 
                        ? 'bg-blue-100 hover:bg-blue-200 transition duration-100 text-right text-sm font-bold border-t-2 border-blue-400'
                        : 'hover:bg-blue-50 transition duration-100 text-right text-sm';
                        
                    newRow.insertCell(0).textContent = row.isResidual ? 'FINAL' : row.month;
                    newRow.cells[0].className = 'text-left font-medium';
                    
                    newRow.insertCell(1).textContent = formatNumber(row.startingBalance, currencyCode);
                    newRow.insertCell(2).textContent = formatNumber(row.payment, currencyCode);
                    
                    const interestCell = newRow.insertCell(3);
                    interestCell.textContent = formatNumber(row.interestPaid, currencyCode);
                    interestCell.className = 'text-right text-red-600'; 

                    const vatCell = newRow.insertCell(4);
                    vatCell.textContent = formatNumber(row.vatAmount, currencyCode);
                    vatCell.className = 'text-right text-orange-500'; 

                    newRow.insertCell(5).textContent = formatNumber(row.principalPaid, currencyCode);

                    const endBalanceCell = newRow.insertCell(6);
                    endBalanceCell.textContent = formatNumber(row.endingBalance, currencyCode);
                    endBalanceCell.className = row.endingBalance <= 0.01 && !isLeasing 
                        ? 'text-right font-bold text-green-700' 
                        : (isLeasing && row.endingBalance > 0 ? 'text-right font-bold text-blue-700' : 'text-right');
                });
            } else { // investment mode
                results.schedule.forEach(row => {
                    const newRow = tableBody.insertRow();
                    newRow.className = 'hover:bg-blue-50 transition duration-100 text-right text-sm';

                    newRow.insertCell(0).textContent = row.month;
                    newRow.cells[0].className = 'text-left font-medium';
                    
                    newRow.insertCell(1).textContent = formatNumber(row.startingBalance, currencyCode);
                    
                    const contributionCell = newRow.insertCell(2);
                    contributionCell.textContent = formatNumber(row.contribution, currencyCode);
                    contributionCell.className = 'text-right text-indigo-600';
                    
                    const interestCell = newRow.insertCell(3);
                    interestCell.textContent = formatNumber(row.interestEarned, currencyCode);
                    interestCell.className = 'text-right text-green-600';
                    
                    newRow.insertCell(4).textContent = formatNumber(row.endingBalance, currencyCode);
                });
            }

            // Render Summary
            renderSummary(mode, results, currencyCode);
        }

        function getTableHeaders(mode, isLeasing) {
            if (mode === 'loan') {
                return isLeasing
                    ? [ 'Month', 'Start Balance', 'Total Payment', 'Interest Paid', 'VAT Paid', 'Principal Reduction', 'End Balance' ]
                    : [ 'Month', 'Start Balance', 'Total Payment', 'Interest Paid', 'VAT Paid', 'Principal Paid', 'End Balance' ];
            } else {
                return [ 'Month', 'Start Balance', 'Contribution', 'Interest Earned', 'End Balance' ];
            }
        }

        function renderTableHeader(mode, isLeasing) {
            const tableHead = document.getElementById('tableHead');
            const headers = getTableHeaders(mode, isLeasing);

            tableHead.innerHTML = `
                <tr>
                    ${headers.map((h, index) => `
                        <th class="px-3 py-3 ${index === 0 ? 'text-left' : 'text-right'} text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ${h}
                        </th>
                    `).join('')}
                </tr>
            `;
            document.getElementById('tableTitle').textContent = isLeasing ? 'Leasing/Financing Schedule' : (mode === 'loan' ? 'Amortization Schedule' : 'Growth Schedule');
        }

        function renderSummary(mode, results, currencyCode) {
            const summaryContent = document.getElementById('summaryContent');
            const downPaymentPercent = document.getElementById('downPaymentPercentDisplay')?.textContent || '0.00%';
            
            document.getElementById('summaryTitle').textContent = 
                results?.isLeasing ? 'Leasing Summary' : (mode === 'loan' ? 'Loan Summary' : 'Investment Summary');
            
            if (!results) {
                summaryContent.innerHTML = '<p class="text-center text-gray-500 italic">Awaiting calculation input.</p>';
                return;
            }

            let html = '';
            
            // Shared duration
            html += `<p class="text-sm text-gray-600 flex justify-between">
                        <span>Duration:</span>
                        <span id="summaryDuration" class="font-semibold text-gray-800">${results.totalMonths} Months</span>
                    </p>`;
            
            if (mode === 'loan') {
                if (results.isLeasing) {
                    // --- LEASING SUMMARY ---
                    html += `
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Full Asset Value:</span>
                            <span class="font-semibold text-gray-800">${formatNumber(results.initialAssetValue, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Down Payment (${downPaymentPercent}):</span>
                            <span class="font-semibold text-gray-800">${formatNumber(results.downPaymentAbsolute, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Amount Financed:</span>
                            <span class="font-semibold text-gray-800">${formatNumber(results.totalPrincipalFinanced, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Residual/Balloon Value:</span>
                            <span class="font-semibold text-blue-600">${formatNumber(document.getElementById('residualValue').value, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between border-y py-2 my-2">
                            <span class="font-bold text-base">Monthly Installment (Base P+I):</span>
                            <span class="font-extrabold text-indigo-700 text-xl">${formatNumber(results.monthlyFixedAmount, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Total Pure Interest Paid:</span>
                            <span class="font-bold text-red-600">${formatNumber(results.totalInterest, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Total VAT Paid (${document.getElementById('vatRate').value}%):</span>
                            <span class="font-bold text-orange-500">${formatNumber(results.totalVAT, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between border-t mt-2 pt-2">
                            <span class="font-bold text-base">Total Cost (DP + Monthly + Residual):</span>
                            <span class="font-extrabold text-green-600 text-xl">${formatNumber(results.finalAmount, currencyCode)}</span>
                        </p>
                    `;
                } else {
                    // --- STANDARD LOAN SUMMARY ---
                    html += `
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Loan Principal:</span>
                            <span class="font-semibold text-gray-800">${formatNumber(results.initialAssetValue, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between border-y py-2 my-2">
                            <span class="font-bold text-base">Monthly Installment (Base P+I):</span>
                            <span class="font-extrabold text-indigo-700 text-xl">${formatNumber(results.monthlyFixedAmount, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Total Pure Interest Paid:</span>
                            <span class="font-bold text-red-600">${formatNumber(results.totalInterest, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between">
                            <span>Total VAT Paid (${document.getElementById('vatRate').value}%):</span>
                            <span class="font-bold text-orange-500">${formatNumber(results.totalVAT, currencyCode)}</span>
                        </p>
                        <p class="text-sm text-gray-600 flex justify-between border-t mt-2 pt-2">
                            <span class="font-bold text-base">Total Repayment (Principal + I + VAT):</span>
                            <span class="font-extrabold text-green-600 text-xl">${formatNumber(results.finalAmount, currencyCode)}</span>
                        </p>
                    `;
                }
            } else { // investment mode
                html += `
                    <p class="text-sm text-gray-600 flex justify-between">
                        <span>Initial Investment:</span>
                        <span class="font-semibold text-gray-800">${formatNumber(results.initialAmount, currencyCode)}</span>
                    </p>
                    <p class="text-sm text-gray-600 flex justify-between">
                        <span>Total Contributions:</span>
                        <span class="font-semibold text-gray-800">${formatNumber(results.totalContributions, currencyCode)}</span>
                    </p>
                    <p class="text-sm text-gray-600 flex justify-between border-y py-2 my-2">
                        <span class="font-bold text-base">Total Interest Earned:</span>
                        <span class="font-extrabold text-green-600 text-lg">${formatNumber(results.totalInterest, currencyCode)}</span>
                    </p>
                    <p class="text-sm text-gray-600 flex justify-between">
                        <span class="font-bold text-base">Final Balance:</span>
                        <span class="font-extrabold text-indigo-600 text-xl">${formatNumber(results.finalAmount, currencyCode)}</span>
                    </p>
                `;
            }
            summaryContent.innerHTML = html;
        }

        function getTableHeaders(mode, isLeasing) {
            if (mode === 'loan') {
                return isLeasing
                    ? [ 'Month', 'Start Balance', 'Total Payment', 'Interest Paid', 'VAT Paid', 'Principal Reduction', 'End Balance' ]
                    : [ 'Month', 'Start Balance', 'Total Payment', 'Interest Paid', 'VAT Paid', 'Principal Paid', 'End Balance' ];
            } else {
                return [ 'Month', 'Start Balance', 'Contribution', 'Interest Earned', 'End Balance' ];
            }
        }

        function renderTableHeader(mode, isLeasing) {
            const tableHead = document.getElementById('tableHead');
            const headers = getTableHeaders(mode, isLeasing);

            tableHead.innerHTML = `
                <tr>
                    ${headers.map((h, index) => `
                        <th class="px-3 py-3 ${index === 0 ? 'text-left' : 'text-right'} text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ${h}
                        </th>
                    `).join('')}
                </tr>
            `;
            document.getElementById('tableTitle').textContent = isLeasing ? 'Leasing/Financing Schedule' : (mode === 'loan' ? 'Amortization Schedule' : 'Growth Schedule');
        }

        function updateUI() {
            const mode = document.querySelector('input[name="calcMode"]:checked').value;
            const isLeasing = document.getElementById('isLeasing')?.checked || false; 
            
            // UI visibility based on mode
            const divLeasingToggle = document.getElementById('divLeasingToggle');
            const divDownPayment = document.getElementById('divDownPayment');
            const labelPrincipal = document.getElementById('labelPrincipal');
            
            if (mode === 'loan') {
                divLeasingToggle.style.display = 'block';
                divDownPayment.style.display = isLeasing ? 'block' : 'none';
                document.getElementById('divVATRate').style.display = 'block';

                labelPrincipal.textContent = isLeasing ? 'Full Asset Value' : 'Loan Principal Amount';
                document.getElementById('divMonthlyPayment').style.display = 'none';

            } else { // investment mode
                divLeasingToggle.style.display = 'none';
                divDownPayment.style.display = 'none';
                document.getElementById('divVATRate').style.display = 'none';
                
                labelPrincipal.textContent = 'Initial Investment Amount';
                document.getElementById('divMonthlyPayment').style.display = 'block';
                
                if (document.getElementById('isLeasing')) {
                    document.getElementById('isLeasing').checked = false;
                }
            }

            // Dynamic Interest Type options
            const interestTypeSelect = document.getElementById('interestType');
            interestTypeSelect.innerHTML = ''; 
            
            if (mode === 'loan') {
                interestTypeSelect.add(new Option('Effective Rate (Amortized)', 'compound'));
                interestTypeSelect.add(new Option('Fixed Rate (Simple Interest)', 'simple'));
                // MANDATORY FIX: Set default to Fixed Rate (simple) for loan/leasing as requested
                interestTypeSelect.value = 'simple'; 
            } else {
                interestTypeSelect.add(new Option('Effective Rate (Compounding)', 'compound'));
                interestTypeSelect.add(new Option('Fixed Rate (Simple Interest)', 'simple'));
                interestTypeSelect.value = 'compound'; 
            }

            // Recalculate and re-render the whole UI
            renderResults();
        }


        // --- Export Functions ---

        function formatDataForExport(data) {
            const currencyCode = document.getElementById('currency').value;
            const formattedRows = data.schedule.map(row => {
                if (data.mode === 'loan') {
                    return [
                        row.isResidual ? 'FINAL' : row.month,
                        formatNumber(row.startingBalance, currencyCode),
                        formatNumber(row.payment, currencyCode),
                        formatNumber(row.interestPaid, currencyCode),
                        formatNumber(row.vatAmount, currencyCode),
                        formatNumber(row.principalPaid, currencyCode),
                        formatNumber(row.endingBalance, currencyCode)
                    ];
                } else {
                    return [
                        row.month,
                        formatNumber(row.startingBalance, currencyCode),
                        formatNumber(row.contribution, currencyCode),
                        formatNumber(row.interestEarned, currencyCode),
                        formatNumber(row.endingBalance, currencyCode)
                    ];
                }
            });
            return formattedRows;
        }

        /**
         * Generates text data with a specified separator (e.g., comma, tab).
         */
        function generateTextData(data, separator) {
            const headerRow = data.headers.join(separator);
            const dataRows = formatDataForExport(data).map(row => row.join(separator)).join('\n');
            return `${headerRow}\n${dataRows}`;
        }

        function generateMarkdown(data) {
            const headers = data.headers;
            const separator = headers.map(() => '---').join(' | ');
            const headerRow = `| ${headers.join(' | ')} |`;
            
            // Format data rows with alignment (right align for numbers)
            const dataRows = formatDataForExport(data).map(row => {
                // Ensure numbers are right-aligned in markdown
                return `| ${row.map((cell, index) => index > 0 ? `${cell}` : cell).join(' | ')} |`;
            }).join('\n');
            
            // Create separator row with right alignment indication for columns 2 onwards
            const alignedSeparator = headers.map((h, index) => index === 0 ? '---' : '---:').join(' | ');


            return `${headerRow}\n| ${alignedSeparator} |\n${dataRows}`;
        }
        
        function copySchedule(format) {
            if (!currentScheduleData) {
                showModal("Export Error", "No schedule data available to copy. Please run a calculation first.");
                return;
            }

            let textToCopy;
            let formatName;
            
            if (format === 'tab') {
                // Use '\t' (tab character) as the separator for Excel/Spreadsheets
                textToCopy = generateTextData(currentScheduleData, '\t');
                formatName = 'Excel (Tab-Separated)';
            } else if (format === 'markdown') {
                textToCopy = generateMarkdown(currentScheduleData);
                formatName = 'Markdown';
            } else {
                return;
            }

            // Use document.execCommand('copy') which is more reliable in iFrame environments
            // where navigator.clipboard permissions are often blocked.
            try {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                // Set styles to make it hidden but selectable
                tempTextArea.style.position = 'fixed';
                tempTextArea.style.top = '0';
                tempTextArea.style.left = '0';
                tempTextArea.style.opacity = '0';
                tempTextArea.style.width = '1px';
                tempTextArea.style.height = '1px';

                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                
                showModal("Success!", `${formatName} schedule successfully copied to clipboard. You can now paste it into Excel or any spreadsheet.`);
            } catch (err) {
                // If execCommand fails, log error and offer manual copy
                console.error('Could not copy text using document.execCommand: ', err);
                showModal("Copy Error", `Failed to copy data as ${formatName}. Please copy manually from the console (logged).`);
                console.log("Data to copy (Copy Manually):", textToCopy);
            }
        }


        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Text/Number inputs (use 'input' event for real-time update)
            const inputIds = [
                'principal', 'rate', 'duration', 'monthlyPayment', 'vatRate', 'residualValue' 
            ];
            
            inputIds.forEach(id => {
                document.getElementById(id)?.addEventListener('input', renderResults);
            });

            // 2. Select inputs (use 'change' event for single update on selection)
            // This is crucial for interestType to ensure the calculation branch is correctly selected.
            const selectIds = [
                'currency', 'durationUnit', 'interestType' 
            ];

            selectIds.forEach(id => {
                document.getElementById(id)?.addEventListener('change', renderResults);
            });

            // Specific handler for Down Payment
            document.getElementById('downPaymentValue').addEventListener('input', handleDownPaymentInput);

            document.getElementById('calculateBtn').addEventListener('click', renderResults);
            
            // Initial UI setup and calculation (defaults to Investment mode)
            updateUI(); 
        });

    </script>
</body>
</html>
